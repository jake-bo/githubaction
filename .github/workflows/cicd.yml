# GitHub Actions Workflow for Terragrunt CI/CD - Terragrunt CI/CD å·¥ä½œæµ
# This workflow handles infrastructure deployment using Terragrunt for multiple environments
# è¯¥å·¥ä½œæµä½¿ç”¨ Terragrunt å¤„ç†å¤šç¯å¢ƒçš„åŸºç¡€è®¾æ–½éƒ¨ç½²

name: CICD-terragrunt-demo

# Global environment variables - å…¨å±€ç¯å¢ƒå˜é‡
env:
  TERRAGRUNT_VERSION: "0.91.4"
  TERRAFORM_VERSION: "1.11.4"
  TERRAGRUNT_DIR: "terragrunt/infra-rd-terragrunt/resource-directories"  

# Trigger condition: Manual trigger - è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘
on:
  workflow_dispatch:
    inputs:
      Deployment:
        description: 'apply or update or destroy - éƒ¨ç½²ã€æ›´æ–°æˆ–åˆ é™¤èµ„æº'
        required: true
        type: choice
        options:
          - apply    # Deploy resources - éƒ¨ç½²èµ„æº
          - update   # Update resources - æ›´æ–°èµ„æº
          - destroy  # Destroy resources - åˆ é™¤èµ„æº
      Environment:
        description: 'Target environment - ç›®æ ‡ç¯å¢ƒ'
        required: true
        type: choice
        options:
          - dev      # Development environment - å¼€å‘ç¯å¢ƒ
          - prod     # Production environment - ç”Ÿäº§ç¯å¢ƒ
            target_uid:
        description: 'Select the account for terraform apply'
        required: true
        type: string
      infrastructure_json_params:
        description: 'require json'
        required: true
        type: string
      task_token:
        description: 'Callback to cloud flow task_token'
        required: true
        type: string
      stage:
        description: 'The account of stage'
        required: true
        type: string
      realm_name:
        description: 'use for set secret'
        required: true
        type: string
nt.inputs.Deployment }}" == "destroy" ]; then
            echo "ğŸ—‘ï¸ Starting terragrunt destroy..."
            terragrunt destroy -auto-approve -input=false 
          fi

  # Production environment approval phase - Manual approval required
  # ç”Ÿäº§ç¯å¢ƒå®¡æ‰¹é˜¶æ®µ - éœ€è¦äººå·¥å®¡æ‰¹
  approval-prod:
    name: Approval Required for Production
    needs: build-and-test  # Depends on build-and-test job successful completion - ä¾èµ– build-and-test job æˆåŠŸå®Œæˆ
    # Trigger condition: environment is prod and operation is apply and previous job succeeded
    # è§¦å‘æ¡ä»¶ï¼šç¯å¢ƒä¸º prod ä¸”æ“ä½œä¸º apply ä¸”å‰ç½®jobæˆåŠŸ
    if: |
      github.event.inputs.Environment == 'prod' &&
      github.event.inputs.Deployment == 'apply' &&
      needs.build-and-test.result == 'success'
    runs-on: standard-ghc
    environment: prod  # Use prod environment configuration (approval rules set) - ä½¿ç”¨ prod ç¯å¢ƒé…ç½®ï¼ˆå·²è®¾ç½®å®¡æ‰¹è§„åˆ™ï¼‰
    
    steps:
      - name: Wait for manual approval
        run: echo "Prod deployment requires manual approval - ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²éœ€è¦æ‰‹åŠ¨å®¡æ‰¹"

  # Production environment deployment - Only executed after approval
  # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½² - åªæœ‰åœ¨å®¡æ‰¹é€šè¿‡åæ‰§è¡Œ
  deploy-prod:
    name: Deploy Production
    needs: 
      - build-and-test    # Requires build and test success - éœ€è¦æ„å»ºæµ‹è¯•æˆåŠŸ
      - approval-prod     # Requires approval passed - éœ€è¦å®¡æ‰¹é€šè¿‡
    # Trigger condition: environment is prod and operation is apply and all previous jobs succeeded
    # è§¦å‘æ¡ä»¶ï¼šç¯å¢ƒä¸º prod ä¸”æ“ä½œä¸º apply ä¸”æ‰€æœ‰å‰ç½®jobéƒ½æˆåŠŸ
    if: |
      github.event.inputs.Environment == 'prod' &&
      github.event.inputs.Deployment == 'apply' &&
      needs.build-and-test.result == 'success' &&
      needs.approval-prod.result == 'success'
    runs-on: standard-ghc
    # environment: production  # Use production environment configuration - ä½¿ç”¨ production ç¯å¢ƒé…ç½®

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Setup Terragrunt environment - è®¾ç½® Terragrunt ç¯å¢ƒ
      - name: Setup Terragrunt
        run: |
          # Install Terraform - å®‰è£… Terraform
          wget -q https://releases.hashicorp.com/terraform/${{ env.TERRAFORM_VERSION }}/terraform_${{ env.TERRAFORM_VERSION }}_linux_amd64.zip
          unzip terraform_${{ env.TERRAFORM_VERSION }}_linux_amd64.zip
          sudo mv terraform /usr/local/bin/
          
          cd ${{ env.TERRAGRUNT_DIR }}
