# GitHub Actions Workflow for Terragrunt CI/CD - Terragrunt CI/CD å·¥ä½œæµ
# This workflow handles infrastructure deployment using Terragrunt for multiple environments
# è¯¥å·¥ä½œæµä½¿ç”¨ Terragrunt å¤„ç†å¤šç¯å¢ƒçš„åŸºç¡€è®¾æ–½éƒ¨ç½²

name: CICD-terragrunt-fc-tg

# Global environment variables - å…¨å±€ç¯å¢ƒå˜é‡
env:
  TERRAGRUNT_VERSION: "0.91.4"
  TERRAFORM_VERSION: "1.11.4"
  TERRAGRUNT_DIR: "sls"  
  ROLE_NAME: "resourcedirectoryaccountaccessrole" 

# Trigger condition: Manual trigger - è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘
on:
  workflow_dispatch:
    inputs:
      Deployment:
        description: 'apply or update or destroy - éƒ¨ç½²ã€æ›´æ–°æˆ–åˆ é™¤èµ„æº'
        required: true
        type: choice
        options:
          - apply    # Deploy resources - éƒ¨ç½²èµ„æº
          - update   # Update resources - æ›´æ–°èµ„æº
          - destroy  # Destroy resources - åˆ é™¤èµ„æº
      Environment:
        description: 'Target environment - ç›®æ ‡ç¯å¢ƒ'
        required: true
        type: choice
        options:
          - dev      # Development environment - å¼€å‘ç¯å¢ƒ
          - prod     # Production environment - ç”Ÿäº§ç¯å¢ƒ
      AccountUID:
        description: 'Alibaba Cloud Account UID (e.g., 1172057920044171) - é˜¿é‡Œäº‘è´¦å·UID'
        required: true
        type: string
        default: '' # å¯ä»¥è®¾ç½®é»˜è®¤å€¼
      infrastructure_json_params:
        description: 'JSON parameters for dynamic inputs - ç”¨äºåŠ¨æ€è¾“å…¥çš„JSONå‚æ•°'
        required: true
        type: string
      # task_token:
      #   description: 'Callback to cloud flow task_token'
      #   required: true
      #   type: string
      # stage:
      #   description: 'The account of stage'
      #   required: true
      #   type: string
      # realm_name:
      #   description: 'use for set secret'
      #   required: true
      #   type: string

jobs:
  # Build and Test phase - executed for all environments - æ„å»ºå’Œæµ‹è¯•é˜¶æ®µ - æ‰€æœ‰ç¯å¢ƒéƒ½éœ€è¦æ‰§è¡Œ
  build-and-test:
    name: "Build & Test - ${{ github.event.inputs.Environment }}"
    runs-on: ubuntu-latest  
    
    steps:
      # Step 1: Checkout code - æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
     
      # # Step 2: Install Terraform - æ­¥éª¤2: å®‰è£… Terraform
      # - name: Install Terraform
      #   run: |
      #     wget -q https://releases.hashicorp.com/terraform/${{ env.TERRAFORM_VERSION }}/terraform_${{ env.TERRAFORM_VERSION }}_linux_amd64.zip
      #     unzip -q terraform_${{ env.TERRAFORM_VERSION }}_linux_amd64.zip
      #     sudo mv terraform /usr/local/bin/
      #     terraform -version

      # # Step 3: Install Terragrunt - æ­¥éª¤3: å®‰è£… Terragrunt
      - name: Install Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
          terragrunt -version

      # # Step 4: Validate directory existence - æ­¥éª¤4: éªŒè¯ç›®å½•æ˜¯å¦å­˜åœ¨
      # - name: Validate directory
      #   run: |
      #     if [ ! -d "${{ env.TERRAGRUNT_DIR }}" ]; then
      #       echo "Error: Directory '${{ env.TERRAGRUNT_DIR }}' not found"
      #       exit 1
      #     fi

      # # Step 5: Dynamic processing of inputs - æ­¥éª¤5: åŠ¨æ€å¤„ç†è¾“å…¥å‚æ•°
      # - name: Dynamic processing of inputs
      #   id: set_secret_name
      #   run: |
      #     echo "secret_ak=${{ github.event.inputs.Environment }}_${{ github.event.inputs.realm_name }}_CICD_ACCOUNT_AK" >> $GITHUB_OUTPUT
      #     echo "secret_sk=${{ github.event.inputs.Environment }}_${{ github.event.inputs.realm_name }}_CICD_ACCOUNT_SK" >> $GITHUB_OUTPUT
      #     lowercase_realm=$(echo "${{ github.event.inputs.realm_name }}" | tr '[:upper:]' '[:lower:]') 
      #     echo "lowercase_realm=${lowercase_realm}" >> $GITHUB_OUTPUT

      # # Step 6: Setup environment-specific variables and dynamically build ARN - æ­¥éª¤6: æ ¹æ®ç¯å¢ƒè®¾ç½®å¯¹åº”çš„ç¯å¢ƒå˜é‡å¹¶åŠ¨æ€æ„å»ºARN
      # - name: Setup environment-specific variables
      #   id: vars
      #   run: |
      #     # åŠ¨æ€æ„å»º ARN
      #     ROLE_ARN="acs:ram::${{ github.event.inputs.AccountUID }}:role/${{ env.ROLE_NAME }}"
      #     echo "ROLE_ARN=$ROLE_ARN" >> $GITHUB_ENV
      #     echo "æ„å»ºçš„ ARN: $ROLE_ARN"
        
      #     # è®¾ç½®ç¯å¢ƒç‰¹å®šçš„ AK/SK
      #     if [ "${{ github.event.inputs.Environment }}" == "dev" ]; then
      #       echo "ACCESS_KEY=${{ secrets.DEV_MASTER_AK }}" >> $GITHUB_ENV
      #       echo "SECRET_KEY=${{ secrets.DEV_MASTER_SK }}" >> $GITHUB_ENV
      #       echo "DEPLOYMENT_AK=${{ secrets.DEV_DEPLOYMENT_ACCOUNT_AK }}" >> $GITHUB_ENV
      #       echo "DEPLOYMENT_SK=${{ secrets.DEV_DEPLOYMENT_ACCOUNT_SK }}" >> $GITHUB_ENV
      #     elif [ "${{ github.event.inputs.Environment }}" == "prod" ]; then
      #       echo "ACCESS_KEY=${{ secrets.PROD_AUTOMATION_AK }}" >> $GITHUB_ENV
      #       echo "SECRET_KEY=${{ secrets.PROD_AUTOMATION_SK }}" >> $GITHUB_ENV
      #       echo "DEPLOYMENT_AK=${{ secrets.PROD_DEPLOYMENT_ACCOUNT_AK }}" >> $GITHUB_ENV
      #       echo "DEPLOYMENT_SK=${{ secrets.PROD_DEPLOYMENT_ACCOUNT_SK }}" >> $GITHUB_ENV
      #     fi

      # Step 7: Parse JSON Input and update terragrunt.hcl - æ­¥éª¤7: è§£æJSONè¾“å…¥å¹¶æ›´æ–°terragrunt.hcl
      - name: Parse JSON Input and update terragrunt.hcl
        run: |
          echo "Parsing JSON parameters and updating terragrunt.hcl..."
          cd ${{ env.TERRAGRUNT_DIR }}
          
          # å®‰è£… jqï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          if ! command -v jq &> /dev/null; then
            echo "Installing jq..."
            sudo apt-get update && sudo apt-get install -y jq
          fi
          
          # ä½¿ç”¨ç‹¬ç«‹çš„è„šæœ¬æ–‡ä»¶
          chmod +x ${{ github.workspace }}/.github/scripts/update_terragrunt.sh
          ${{ github.workspace }}/.github/scripts/update_terragrunt.sh '${{ github.event.inputs.infrastructure_json_params }}' 'terragrunt.hcl'
          ls -l
          cat terragrunt.hcl
      # # Step 8: Inject credentials to config - æ­¥éª¤8: æ³¨å…¥å‡­è¯åˆ°é…ç½®æ–‡ä»¶
      # - name: Inject credentials to config
      #   uses: ./.github/actions/inject-credentials
      #   env: 
      #     SECRET_AK_VALUE: ${{ secrets[steps.set_secret_name.outputs.secret_ak] }}
      #     SECRET_SK_VALUE: ${{ secrets[steps.set_secret_name.outputs.secret_sk] }}
      #   with:
      #     config_json_path: ${{ github.workspace }}/config.json
      #     target_directory: ${{ env.TERRAGRUNT_DIR }}
      #     access_key: ${{ env.DEPLOYMENT_AK }}
      #     secret_key: ${{ env.DEPLOYMENT_SK }}
      #     target_uid: ${{ github.event.inputs.AccountUID }}
      #     env: ${{ github.event.inputs.Environment }}
      #     cicd_ak: ${{ env.SECRET_AK_VALUE }}  
      #     cicd_sk: ${{ env.SECRET_SK_VALUE }}
      #     stage: ${{ github.event.inputs.stage }}
      #     realm_name: ${{ steps.set_secret_name.outputs.lowercase_realm }}

      # # Step 9: Copy config json to default directory - æ­¥éª¤9: å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°é»˜è®¤ç›®å½•
      # - name: Copy config json to default directory
      #   run: |
      #     cp ${{ github.workspace }}/config.json ~/.aliyun/config.json

      # # Step 10: Format HCL configuration files - æ­¥éª¤10: æ ¼å¼åŒ– HCL é…ç½®æ–‡ä»¶
      # - name: Terragrunt hcl format
      #   env:
      #     TF_VAR_assume_role_arn: ${{ env.ROLE_ARN }}
      #     ALICLOUD_ACCESS_KEY: ${{ env.ACCESS_KEY }}
      #     ALICLOUD_SECRET_KEY: ${{ env.SECRET_KEY }}
      #   run: |
      #     cd ${{ env.TERRAGRUNT_DIR }}
      #     terragrunt hcl format

      # # Step 11: Validate Terraform configuration syntax - æ­¥éª¤11: éªŒè¯ Terraform é…ç½®è¯­æ³•
      # - name: Terragrunt Validate
      #   env:
      #     TF_VAR_assume_role_arn: ${{ env.ROLE_ARN }}
      #     ALICLOUD_ACCESS_KEY: ${{ env.ACCESS_KEY }}
      #     ALICLOUD_SECRET_KEY: ${{ env.SECRET_KEY }}
      #   run: |
      #     cd ${{ env.TERRAGRUNT_DIR }}
      #     terragrunt validate

      # # Step 12: Initialize Terraform working directory - æ­¥éª¤12: åˆå§‹åŒ– Terraform å·¥ä½œç›®å½•
      # - name: Terragrunt Init
      #   env:
      #     TF_VAR_assume_role_arn: ${{ env.ROLE_ARN }}
      #     ALICLOUD_ACCESS_KEY: ${{ env.ACCESS_KEY }}
      #     ALICLOUD_SECRET_KEY: ${{ env.SECRET_KEY }}
      #   run: |
      #     cd ${{ env.TERRAGRUNT_DIR }}
      #     terragrunt init

      # # Step 13: Generate execution plan - æ­¥éª¤13: ç”Ÿæˆæ‰§è¡Œè®¡åˆ’
      # - name: Terragrunt Plan
      #   env: 
      #     ALICLOUD_ACCESS_KEY: ${{ env.ACCESS_KEY }}
      #     ALICLOUD_SECRET_KEY: ${{ env.SECRET_KEY }}
      #     TF_VAR_assume_role_arn: ${{ env.ROLE_ARN }}
      #   # Execute plan for apply, update or destroy operations - åœ¨ applyã€update æˆ– destroy æ“ä½œæ—¶æ‰§è¡Œ plan
      #   if: github.event.inputs.Deployment == 'apply' || github.event.inputs.Deployment == 'update' || github.event.inputs.Deployment == 'destroy'
      #   run: |
      #     cd ${{ env.TERRAGRUNT_DIR }}
      #     if [ "${{ github.event.inputs.Deployment }}" == "apply" ]; then
      #       # Plan for creating resources - åˆ›å»ºèµ„æºæ—¶çš„è®¡åˆ’
      #       terragrunt plan -input=false -no-color
      #     elif [ "${{ github.event.inputs.Deployment }}" == "update" ]; then
      #       # Plan for updating resources - æ›´æ–°èµ„æºæ—¶çš„è®¡åˆ’
      #       terragrunt plan -input=false -no-color
      #     elif [ "${{ github.event.inputs.Deployment }}" == "destroy" ]; then
      #       # Plan for destroying resources (destroy plan) - åˆ é™¤èµ„æºæ—¶çš„è®¡åˆ’ï¼ˆdestroy planï¼‰
      #       terragrunt plan -destroy -input=false -no-color
      #     fi

      # # Step 14: Execute deployment based on environment - æ­¥éª¤14: æ ¹æ®ç¯å¢ƒæ‰§è¡Œéƒ¨ç½²
      # - name: Execute Terragrunt Deployment
      #   env: 
      #     ALICLOUD_ACCESS_KEY: ${{ env.ACCESS_KEY }}
      #     ALICLOUD_SECRET_KEY: ${{ env.SECRET_KEY }}
      #     TF_VAR_assume_role_arn: ${{ env.ROLE_ARN }}
      #   run: |
      #     set -e  # Exit immediately on error - é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
      #     cd ${{ env.TERRAGRUNT_DIR }}
          
      #     if [ "${{ github.event.inputs.Deployment }}" == "apply" ]; then
      #       echo "ğŸš€ Starting terragrunt apply..."
      #       terragrunt apply -auto-approve -input=false 
      #     elif [ "${{ github.event.inputs.Deployment }}" == "update" ]; then
      #       echo "ğŸ”„ Starting terragrunt apply (update)..."
      #       terragrunt apply -auto-approve -input=false 
      #     elif [ "${{ github.event.inputs.Deployment }}" == "destroy" ]; then
      #       echo "ğŸ—‘ï¸ Starting terragrunt destroy..."
      #       terragrunt destroy -auto-approve -input=false 
      #     fi

      # # Step 15: Sent workflow status to remote api
      # - name: Sent workflow status to remote api
      #   if: always()
      #   run: | 
      #     if [ "${{ job.status }}" == "success" ]; then
      #       aliyun fnf ReportTaskSucceeded  --region cn-shanghai --Output '{"status": "success"}' --TaskToken ${{ github.event.inputs.task_token }} 
      #     else
      #       aliyun fnf ReportTaskFailed --region cn-shanghai --TaskToken ${{ github.event.inputs.task_token }} --Error "WorkflowFailed"
      #     fi
